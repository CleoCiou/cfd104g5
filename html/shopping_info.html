<!DOCTYPE html>
<html lang="en">
@@include('layout/head.html', {
    'title': '填寫資料'
})
<link rel="stylesheet" href="css/shopping_cart.css">
<body>
    
    <!-- 網頁頭 by NJ -->
    @@include('layout/header.html')



<!-- 網頁內容 -->
    <main id="app">
        <!-- 購物車流程 -->
        <section class="shopping_circle">
            <div class="container">
                <ol class="shopping_process">
                    <li class="item">Step 1</li>
                    <li class="item active">Step 2</li>
                    <li class="item">Step 3</li>
                </ol>
            </div>
        </section>
        <section class="shopping_cart">
            <div class="container">
                <!-- 購物車內容 -->
                <div class="cart_detail">
                    <!-- 購物車header -->
                    <div class="cart_header">
                        <div class="item_detail">商品</div>
                        <div class="price">單價</div>
                        <div class="count">數量</div> 
                        <div class="amount">總計</div>
                    </div>
                    <!-- 購物車body -->
                    <div class="cart_body" v-for="(row, index) in cartFull">
                        <div class="cart_body_box">
                            <div class="item_detail">
                                <div class="cart_card">
                                    <div class="img_box">
                                        <img :src="imgSrc(row.prodImage1)" alt="">
                                    </div>
                                    <div class="txt_box">
                                        <p>{{row.prodName}}{{row.cateName}}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="price"><span>NT${{row.price}}</span></div>
                            <div class="count">
                                {{cartFull[index].amount}}
                            </div> 
                            <div class="amount">NT$<span>{{sum(index)}}</span></div>
                        </div>
                    </div>                        
                </div>
            </div>
        </section>

        <!-- 填寫資料區 -->
        <section class="cart_deliver">
            <div class="container">
                <div class="customer_info">
                    <div class="pay_way">
                        <p>付款方式</p>
                        <select id="payWay">
                            <option>請選擇</option>
                            <option>轉帳付款</option>
                            <option>信用卡</option>
                        </select>
                        <p>信用卡卡號</p>
                        <input type="text" id="credit" @keyup="checkCredit()" placeholder="0000-0000-0000-0000">
                        <p id="carderror">卡號有誤</p>
                    </div>
                </div>
                <div class="cart_info_right">
                    <div class="order_total">
                        <div class="first_price">
                            <h4>小計：NT${{total}}</h4>
                        </div>
                        <div class="delivery_fee">
                            <h4>運費：NT${{fee}}</h4>
                        </div>
                        <div class="total_price">
                            <h4>總計：NT$<span id="totalPrice">{{total+fee}}</span></h4>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- 按鈕 -->
        <section class="confirm_btn">
            <div class="container">
                <div class="confirm_btns">
                    <a href="shopping_cart.html" id="nextPage"><button class="third_btn">上一步</button></a>
                    <a href="shopping_confirm.html"><button class="primary_btn" @click="insertData">確認訂單</button></a>
                </div>
            </div>
        </section>

        <!-- 底部推薦商品 -->
        <section class="cart_bottom">
            <div class="container">
                <h3>主打商品</h3>
                <div class="item_box">
                    <div class="item" v-for=" (i, idx) in queryResult">
                        <a @click="getPromptProduct(idx)">
                            <div class="img_box">
                                <img :src="imgSrc(i.prodImage1)" alt="">
                            </div>
                        </a>
                        <div class="txt_box">
                            <p>{{i.prodName}}{{i.cateName}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>


<!-- 網頁尾 By NJ -->
@@include('layout/footer.html')
<script>
    //驗證登入
    if (getSessionData() === false) {
        $('main').css({opacity: 0});
        alert('請先登入');
        $('section.login').removeClass('display_none');
        document.body.classList.add('login_hidden');
    }
    else {
        getMemberData();
    }
    function getMemberData(){
        new Vue({
            el:'#app',
            data:{
                queryResult: [],
                cart:[],
                prodInfoList: [],
                selectOrderNo:[],
                userData: getSessionData(),
            },
            mounted() {
                this.getList();
                this.getProdInfo_vue();
                this.getPrompt();
                this.checkCredit();
            },

            methods:{
                sum(idx){
                    let prod = this.cartFull[idx];
                    return parseInt(prod.price) * parseInt(this.cart[idx].amount)
                },


                getList() {
                    let cart = JSON.parse(localStorage.getItem("cart"));
                    this.cart = cart;
                },
                
                // 底部商品列
                getPrompt(){
                    $.ajax({
                        type: 'POST',
                        url: 'phps/select.php',
                        data: {

                            table: 'product',

                            joinTable: 'product_category',

                            joinOn:'prodCateNo',

                            queryCol: "prodName, prodImage1, cateName, prodNo",

                            other: 'limit 4'
                        },
                        success: data =>{
                            if (data.msg !== false){
                                this.queryResult = data.msg;
                            }
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                },
                
                getPromptProduct(index){
                    let prod_Num = this.queryResult[index].prodNo;
                    localStorage.setItem('prodNumber',`${prod_Num}`);  
                    window.location.href = "product.html";
                },

                getProdInfo_vue() {
                    $.ajax({
                        type: 'POST',
                        url: 'phps/select.php',
                        data: {

                            table: 'product',

                            joinTable: 'product_category',

                            joinOn:'prodCateNo',

                            queryCol: "prodName, price, prodImage1, cateName, prodNo",
                        },
                        success: data =>{
                            if (data.msg !== false){
                                this.prodInfoList = data.msg;
                            }
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: 'phps/select.php',
                        data: {

                            table: 'orders',

                            queryCol: "orderNo",

                            other: 'ORDER BY orderNo DESC LIMIT 1'

                        },
                        success: data =>{
                            if (data.msg !== false){
                                this.selectOrderNo = data.msg;
                            }
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                },

                // 更新資料庫
                insertData() {
                    let cart_data =  JSON.parse(localStorage.getItem('cart'));
                    // console.log(cart_data);
                    let payWay = document.querySelector('#payWay').value;
                    let no = this.userData.userNo;
                    let totalPrice = document.querySelector('#totalPrice').innerText;
                    let credit = document.querySelector('#credit').value;
                    let nextPage = document.querySelector('#nextPage')
                    if(payWay == "請選擇" || credit == ""){
                        alert('必填欄位未填寫');
                        event.preventDefault();
                    }else{                          
                        // 新增資料
                        $.ajax({
                            type: 'POST',
                            url: 'phps/insert.php',
                            data: {
                                table: 'orders',
                                insertValue: `default, ${no}, default, ${totalPrice}, "${payWay}", ${credit}, default`
                            },
                            success: data => {
                            },
                            error: err => {
                                console.log('ajax error');
                            }
                        });
                        let valueMul = [];
                        let orderNum = Number(this.selectOrderNo[0].orderNo) + 1;
                        console.log(orderNum);
                        for (let i = 0; i < cart_data.length; i++) {
                            let str = `${orderNum}, ${cart_data[i].prodNo}, ${cart_data[i].amount}`;
                            valueMul.push(str);
                        }
                        valueMul = valueMul.join('),(');                 
                        $.ajax({
                            type: 'POST',
                            url: 'phps/insert.php',
                            data: {
                                table: 'order_item',
                                insertValue: `${valueMul}`
                            },
                            success: data => {
                            },
                            error: err => {
                                console.log('ajax error');
                            }
                        })
                        alert('訂購成功');
                    }


                },
                
                imgSrc(image){
                    let path = `images/shop/tarot`;
                    return `${path}/${image}`;
                },
                //信用卡驗證
                checkCredit(){
                    let cardReg = /\b(?:3[47]\d{2}([\ \-]?)\d{6}\1\d|(?:(?:4\d|5[1-5]|65)\d{2}|6011)([\ \-]?)\d{4}\2\d{4}\2)\d{4}\b/
                    let card = document.getElementById('credit');   //取得id number 設變數名為card
                    let alert = document.getElementById('carderror');   //取得id error 設變數名為alert
                    if(cardReg.test(card.value)){        //如果與rel比較為true
                        alert.style.display="none"  
                    }else{                          //如果比對為false
                        alert.style.display="block"  //顯示錯誤訊息
                    }
                },
                //付款方式變化
                payWayChange(){
                    let payMethod = document.querySelector('#payWay').value;
                    let card = document.getElementById('credit');   //取得id number 設變數名為card
                    let alert = document.getElementById('carderror');   //取得id error 設變數名為alert
                    if(payMethod === "轉帳付款"){
                        alert.style.display="none"
                        card.style.display="none"  
                    }else{
                        alert.style.display="block"
                        card.style.display="block"  
                    }
                    console.log(payMethod);
                }
            },
            computed:{
                cartFull() {
                    return this.cart.map(v => {
                        let obj = this.prodInfoList.find(item => v.prodNo == item.prodNo);
                        return {
                            ...obj,
                            ...v
                        };
                    })
                },
            
                total() {
                    let subtotal = 0;
                    for(let i = 0; i < this.cart.length; i++){
                        subtotal += this.sum(i);
                    }
                    return subtotal;
                },
                fee(){
                    let deliFee = 0;
                    if(this.cart.length == 0){
                        deliFee = 0;
                    }else{
                        deliFee = 60
                    }
                    return deliFee;
                },
            }
        });
    };
</script>

</body>
</html>