<!DOCTYPE html>
<html lang="en">
@@include('layout/head.html', {
    'title': '發表文章'
})
<body>
    <!-- 網頁頭 by NJ -->
    @@include('layout/header.html')  
    <main id="app">
        <section class="discuss discuss_write">
            <div class="container">
                <!-- 撰寫文章區 by JC -->
                <div class="article_writing_board">
                    <!-- 選擇看板 -->
                    <div class="choose_theme">
                        <!-- <select id="article_mine_month" v-model="topic" @change="topic(index)"> -->
                            <select id="article_mine_month" v-model="topic">
                            <!-- <option  selected disabled>選擇看板</option> -->
                            <option v-for="(cate,index) in cates" :value="cate.topicNo">{{cate.topicName}}</option>
                        </select>
                    </div>
                    
                    <div class="write_head">
                        <div class="author img_box">
                            <img :src="imgSrc(userData.sticker)" alt="會員頭像">
                        </div>
                        <div class="writer_detail_box">
                            <p>{{ userData.userId }}</p>
                            <p class="getTime">{{getCurrentTime}}</p>
                        </div>
                    </div>
                    <form action="">
                        <!-- 文章標題 -->
                        <div class="write_title">
                            <label>標題
                            <input type="text" name="title" id="write_txt_title" maxlength="20" v-model="title">
                            </label>
                        </div>
                        <!-- 寫內容的地方 -->
                        <div class="write_content" id="write_content">
                            <label>內容
                            <textarea name="content" rows="12" placeholder="請輸入文章內容..." v-model="content" type="text"></textarea>
                            </label>
                        </div>
                        <!-- 最下面 選圖片 清除 發布 -->
                        <div class="write_bottom">
                            <div class="write_using_btn">
                                <a :href=backUrl><input type="button" class="third_btn" value="取消"></a>
                                <input type="button" class="third_btn" @click="insertData" value="發佈"></a>
                                
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

    </main>
    <!-- 網頁尾 By NJ -->
    @@include('layout/footer.html')
    <script>
            // 若尚未登入
        if (getSessionData() === false) {
            $('section.discuss.discuss_write').css({opacity: 0});
            alert('請先登入');
            $('section.login').removeClass('display_none');
            document.body.classList.add('login_hidden');
        }
        else {
            getMemberData();
        }

        function getMemberData(){
            new Vue({
                el: '#app',
                data: { //變數放這
                    userData: getSessionData(),
                    cates: [],
                    // authorImg: './images/teller_mem/',
                    backUrl: 'discuss.html',
                    members: [],
                    topic: 1,
                    title: '',
                    content: '',
                },
                created() {
                    this.getTopic();
                },
                methods: {
                    getTopic() {
                        $.ajax({
                            type: 'POST',
                            url: 'phps/select.php',
                            
                            data: {
                                table: 'article_topic',
                                queryCol: 'topicNo, topicName',

                            },
                            success:  data => {
                                // console.log(data.msg);
                                if (data.msg !== false){
                                    this.cates = data.msg;
                                    // console.log(this.cates);
                                }
                            },
                            error: err => {
                                console.log('ajax error');
                            }
                        });
                    },
                    insertData() {
                        let topicNo = this.topic;
                        // console.log(topicNo);
                        let title = this.title;
                        let content = this.content;
                        let no = this.userData.userNo;

                        // 檢查欄位是否已填
                        
                        if (!topicNo) {
                            this.resetInput('請選擇看板名稱');
                            return;
                        }
                        if(!title){
                            this.resetInput('請輸入標題');
                            return;
                        }
                        if(!content){
                            this.resetInput('請輸入內容');
                            return;
                        }
                        // 新增資料
                        $.ajax({
                            type: 'POST',
                            url: 'phps/insert.php',
                            data: {
                                table: 'article',
                                // col: 'artNo, memNo, artTime, topicNo, title , content, likes, artFavs, msgs, artImage, status, activeIndex, favIndex',
                                insertValue: `null, '${no}', CURRENT_TIMESTAMP , '${topicNo}' ,'${title}', '${content}', default, default, default, default, default, default, default`
                            },
                            success: data => {
                                // this.resetInput('成功發表文章!');
                                alert('成功發表文章');
                                console.log(data.sql);
                                window.location.href = "discuss.html";
                            },
                            error: err => {
                                console.log('ajax error');
                            }
                        });
                        
                    },
                    resetInput(msg = false) {
                        if(msg) alert(msg);
                        console.log(msg);
                    },
                    changeTopic(index){
                        this.topic = this.cates[index]
                    },
                    imgSrc(image){
                        let path = `images/member`;
                        return `${path}/${image}`;
                    },
                    
                },
                computed: {
                    getCurrentTime(){
                        var today = new Date();
                        var date = today.getFullYear() + '-' + (today.getMonth()+1) + '-' + today.getDate();
                        var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                        var dateTime = date + ' ' +time;
                        return dateTime;
                    },
                   
                }
            })
        }
        
    </script>
</body>
</html>