<!DOCTYPE html>
<html lang="en">
@@include('layout/head.html', {
	'title': '塔羅'
})
<body>
    
<!-- header -->
@@include('layout/header.html')

<!-- 線上占卜 by NJ -->
<main>
    <section class="draw_cards">
        <div class="container">

    		<!-- 抽牌 -->
            <div class="cards_box">
                <p>請選擇一張牌</p>
				
				<!-- 抽牌圈 -->
                <div class="all">
                    <ul class="cards"></ul>
                </div>
            </div>

			<!-- 占卜詳解 -->
			<div class="detail_box">
				<!-- 抽到的牌 圖片 -->
				<div class="img_box">
					<div class="item font">
						<img src="./images/tarot_cards/00The_fool.png">
					</div>
					<div class="item back">
						<img src="./images/draw_cards/draw_cards_back.jpg">
					</div>
				</div>

				<!-- 文字解析 -->
				<div class="txt_box">
					<!-- 牌名 -->
					<div class="item txt_header">
						<h3>愚者 The Fool</h3>
					</div>
					<!-- 解析內容 -->
					<div class="item txt_content">
						<p>愚者塔羅牌意義：旅程</p>
						<p>它表明您希望尋求未來的機會，但缺乏明確的具體計劃。由於你沒有什麼顧慮，有時這些特質反而會給你帶來意想不到的成功。然而沒有遠見，使你容易產生動搖，當遇到太多障礙的時候往往會失去原有的目標。 當你想要開始諸如學習，搬家或簽署商業協議之類的，追隨你的直覺並付出行動是不錯的方式。</p>
					</div>
					<!-- 其他連結 -->
					<div class="item txt_footer action">
						<li class="unselected_btn"><a href="online_divination.html">重新抽牌</a></li>
						<li class="unselected_btn"><a href="teller_mem.html">占卜師總覽</a></li>
						<li class="unselected_btn"><a href="be_tellers.html">體驗占卜師</a></li>
						<li class="unselected_btn"><a href="shop.html">前往商城</a></li>
					</div>
				</div>
			</div>

        </div>
    </section>
</main>

<!-- footer -->
@@include('layout/footer.html')

<script>
	// 牌數
	const CARDINDEX = 22;
	// 抽牌圈
	const CARDSEL = document.querySelector('.cards');
	// 預選牌
	let selectedIndex = 0;
	// 設定抽牌圈牌數
	CARDSEL.style.setProperty('--event-count', CARDINDEX);
	// 抽牌提示
	let words = document.querySelector('.cards_box > p');
	let wordsTween;
	// 解牌提示
	let clickSelected;

	init();
	
	function init() {
		// 創造抽牌圈
		for(let i = 0; i < CARDINDEX; i++) {
			const EVENTEL = document.createElement('li');
			EVENTEL.classList.add('event');
			// 設定牌的旋轉角度
			EVENTEL.style.setProperty('--event-index', i);
			// 抽牌放中間
			EVENTEL.addEventListener('click',selectCard);
			// 創造牌的背景圖片
			const IMGEL = document.createElement('img');
			IMGEL.src = './images/draw_cards/draw_cards_back.jpg';
			// 將圖片放在牌上
			EVENTEL.append(IMGEL);
			// 將牌放進抽牌圈
			CARDSEL.append(EVENTEL);
		}

		// 抽牌提示
		wordsTween =TweenMax.to(words, {
			opacity: .3,
			duration: 2,
			repeat: -1,
			ease: Expo.easeNone,
			yoyo: true
		});
	}

	function selectCard(e) {

		// 取得選擇的卡片
		let card = e.target.parentNode;
		let idx = card.style.getPropertyValue('--event-index');

		// 關閉抽卡提示
		wordsTween.kill();
		words.style.opacity = 0;

		// 抽牌圈數量
		let allCard = document.querySelectorAll('li.event');

		// 若選擇抽出來的卡，顯示解析
		if (card.classList.contains('selected')) {
			gsap.to(CARDSEL, {
				rotate: 10
			})
			gsap.to($('ul > li.event:not(.selected)'), {
				'--scale': 0
			})
			gsap.to($('ul > li.event.selected'), {
				rotate: 260
			})
			// 加入一點點的動畫畫畫畫畫
			gsap.set('ul', {transformStyle: 'reserve-3d'});
			gsap.set('li.event.selected', {rotationX: 0, transition: 0})
			gsap.to('li.event.selected', {
				duration: 1,
				rotationX: 720,
				left: '50%',
				top: '50%',
				translateX: '-50%',
				translateY: '-50%',
				scale: 3,
				boxShadow: '0 0 5px 0.5em #CFB886',
				ease: Power1.easeOut,

				onComplete: showDetail
			});

			return false;
		}

		// 若已有選擇卡片，使其復位，刪除該牌解牌提示特效
		let selectedCard = document.querySelector('.selected');
		if (selectedCard) {
			selectedCard.classList.remove('selected');
			selectedCard.style.removeProperty('transform');

			// 一圈22張牌
			card.parentNode.style.setProperty('--event-count', 22);
			// 取得先前選到牌的編號
			let selectedIdx = selectedCard.style.getPropertyValue('--event-index');
			// 移除解牌提示
			selectedCard.removeAttribute('style');
			clickSelected.kill(selectedCard);
			for (let i = (parseInt(selectedIdx)); i < 22; i++) {
				// 抽出牌後面牌的號碼往後歸位
				allCard[i].style.setProperty('--event-index', i);
			}
		}

		// 設定選擇卡片出來的旋轉方向
		card.classList.add('selected');
		if (idx > 10) {
			// 左邊抽牌出來順時針旋轉
			card.style.transform = 'rotate(360deg)';
		}
		else {
			// 右邊抽牌出來逆時針旋轉
			card.style.transform = 'none';
		}

		// 抽一張牌，一圈剩21張牌
		card.parentNode.style.setProperty('--event-count', 21);
		for (let i = (parseInt(idx) + 1); i < 22; i++) {
			// 抽出牌後面的牌編號往前補位
			allCard[i].style.setProperty('--event-index', i-1);
		}

		// 解牌提示特效
		clickSelected = TweenMax.to(card, {
			duration: 1,
			repeat: -1,
			boxShadow: '0 0 10px 0.5em #CFB886CC',
			yoyo: true
		});
	}

	function showDetail() {
		// 取得選擇的卡片
		let card = document.querySelector('li.event.selected');
		// 關閉解牌提示特效
		clickSelected.kill();
		card.removeAttribute('style');

		// 取得解牌詳解容器，設定位置至抽到的卡
		// 讓抽到的牌消失: 因為他兩面是一樣的
		// 容器分正反面，翻過來會有詳解
		// 顯示容器
		let detailImgBox = document.querySelector('.detail_box .img_box');
		$('.detail_box .img_box').css({
			width: card.getBoundingClientRect().width,
			height: card.getBoundingClientRect().height,
			top: card.getBoundingClientRect().top,
			left: card.getBoundingClientRect().left,
		});

		detailImgBox.parentNode.style.display = 'block';
		$('ul.cards').css({display: 'none'});

		// 轉吧轉吧七彩霓虹燈~
		// 解析 --圖片
		let cardTop = '0';
		let cardLeft = '0';
		let offsetX = '0';
		
		// 電腦動畫
		if (window.screen.width >= 768) {
			cardTop = '20%';
			cardLeft = '20%';
		}
		// 手機動畫
		else {
			cardTop = '20%';
			cardLeft = '50%';
			offsetX = '-50%';
		}
		gsap.fromTo(detailImgBox, {
			rotationY: 0,
			boxShadow: '0 0 20px .5em #CFB88688',
		}, 
		{
			top: cardTop,
			left: cardLeft,
			rotationY: -180,
			translateX: offsetX,
			boxShadow: '0 0 20px 1em #CFB88688',
			duration: 1.5,
		})

		// 解析 --文字
		let detailOffsetX = '0';
		let detailOffsetY = '0';

		// 電腦動畫
		if (window.screen.width >= 768) {
			detailOffsetX = '20%';
			detailOffsetY = '20%';
		}

		gsap.to($('.detail_box'), {
			duration: 1,
			backgroundColor: '#5555'
		})
		gsap.fromTo($('.detail_box .txt_box'), {
			translateX: '0',
			translateY: '0',
			opacity: 0
		},
		{
			translateX: detailOffsetX,
			translateY: detailOffsetY,
			opacity: 1,
			duration: 1.5,
		})
		
	}
</script>

</body>
</html>