<!DOCTYPE html>
<html lang="en">


@@include('layout/head.html', {
    'title': '後台管理'
})
        

<body>
    <section id="app" class="back container">
        
        <my-nav></my-nav>
        

        <!-- 管理內容區 -->
        <div class="contain">
            <!-- 登出 -->
            <header>
                <div class="burger"></div>
                <button class="third_btn">登出</button>
            </header>

            <!-- 管理內容 -->
            <main>
                <div class="container">
                    <!-- 表格上方操作列 -->
                    <top-action-bar :action-btn="actionBtn" @update-db="updateDb"></top-action-bar>
                 
                    
                    <!-- 資料內容 -->
                    <!-- 有用: 代表v-bind綁住 代表資料從Vue來 -->
                    <my-table :query-result="queryResult" :col-name="colName" @deconstruct-row="deconstructRow" :deconstruct-result="deconstructResult" @get-detail="getDetail"></my-table>
                    
                    <!-- 彈出視窗 -->
                    <form enctype="multipart/form-data" id="good">
                        <div :class="popup">
                            <div class="content_box">
                                <!-- 商品名稱 -->
                                <div class="info_box prodName">
                                    <label for="adminName">商品名稱</label>
                                    <input name="prodName" type="text" :value="detail.prodName">
                                </div>
                                <!-- 商品類別 -->
                                <div class="info_box cateType">
                                    <label>類別</label>
                                    <select name="prodCateNooN" v-model="detail.cateType">
                                        <option>塔羅</option>
                                        <option>星座</option>
                                    </select>
                                </div>
                                <!-- 商品項目 -->
                                <div class="info_box catename">
                                    <label>品項</label>
                                    <select name="prodCateNo" v-model="detail.cateName" >
                                        <option>項鍊</option>
                                        <option>手鍊</option>
                                        <option>幸運石</option>
                                    </select>
                                </div>
                                <!-- 商品描述 -->
                                <div class="info_box prodIntro">
                                    <label>商品描述</label>
                                    <textarea name="prodIntro" id="prodIntro" v-model="detail.prodIntro"></textarea>
                                </div>
                                <!-- 商品圖片 -->
                        
                                    <div class="info_box prodImage">
                                        <label class="prod_img_box" for="prodImage">
                                            <img aria-placeholder="請選擇圖片" :src="'images/'+detail.prodImage1 ">
                                        </label>
                                        <input type="file" id="prodImage" class="displaynone" name="prodImage1">
                                    </div>
                                    <div class="info_box prodImage">
                                        <label class="prod_img_box" for="prodImage">
                                            <img aria-placeholder="請選擇圖片" :src="'images/'+detail.prodImage2">
                                        </label>
                                        <input type="file" id="prodImage" class="displaynone" name="prodImage2">
                                    </div>
                                    <div class="info_box prodImage">
                                        <label class="prod_img_box" for="prodImage">
                                            <img aria-placeholder="請選擇圖片" :src="'images/'+detail.prodImage3">
                                        </label>
                                        <input type="file" id="prodImage" class="displaynone" name="prodImage3">
                                    </div>
                        
                        
                                <!-- 儲存/取消 -->
                                <div class="info_box action_box">
                                    <div class="action">
                                        <button type="button" class="third_btn" @click="displaynone=true">取消</button>
                                        <!-- <button class="secondary_btn" @click="displaynone=true">儲存</button> -->
                                        <button type="button" class="secondary_btn" @click="update">儲存</button>
                                        <!-- button點了之後 為了不讓他預設會跳轉 type用button -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                </div>
            </main>
            
        </div>
    </section>
</body>
</html>
<script src="js/back_component.js"></script>
<script>
    $(document).ready(function() {
        new Vue({
            el: '#app',
            data: {
                // 資料表顯示欄位名稱
                colName: [
                    '商品名稱',
                    '項目類別',
                    '項目',
                    '單價',
                    '商品圖片',
                    '商品介紹',
                    '商品狀態'
                ],
                // 後端回傳查詢結果
                queryResult: '',
                // 解構結果
                deconstructResult: {},
                // 結果解構後詳細內容會縮為一個按鈕，點擊跳popup視窗
                detail: {},
                // popup視窗開關class
                displaynone: true,
                // 表格上方操作列按鈕
                actionBtn: ['新增', '修改', '下架']
            },
            mounted() {
                this.getCol();
                // this.update();
            },
            methods: {
                // 依選擇項目取得資料表
                getCol() {
                    let thisVue = this;
                    $.ajax({
                        type: 'POST',
                        // phps/back_products_insert_test.php
                        // phps/back_getCol.php
                        url: 'phps/back_getCol.php',
                        data: {
                            table: 'product',
                        },
                        success: function(data) {
                            data = JSON.parse(data);
                            // console.log(data.msg[0]);

                            thisVue.queryResult = data.msg;
                           
                        },
                        error: function() {
                            console.log('ajax error');
                        }
                    });
                },

                update(){
                    let thisVue = this;
                    let xhr = new XMLHttpRequest();
                    xhr.onload = function(){
                        alert(xhr.responseText);
                    }
                    // insert
                    xhr.open("post","phps/back_products_insert_test.php",true);
                    let form = document.getElementById("good");
                    let formData = new FormData(form);
                    xhr.send(formData);

                    console.log(formData);
                    // console.log(formData);
                    // $.ajax({
                    //     // phps/back_getCol.php
                    //     type: 'POST',
                    //     url: 'phps/back_products_insert_test.php',
                    //     // data: {
                    //     //     // table: 'product',
                    //     //     table: 'product',
                    //     //     insertValue: `'${detail.cateName}', '${detail.cateType}', default, default`
                    //     //     // a:detail.cateName,
                    //     //     // b:detail.cateType,
                    //     // },
                    //     data: formData,
                    //     contentType:false,
                    //     success: function(data) {
                    //         // data = JSON.parse(data);
                    //         console.log(data);
                    //         // this.detail.cateName = data

                    //         // thisVue.queryResult = data.msg;
                    //         // console.log(data)
                    //         thisVue.resetInput('新增成功');
                    //         thisVue.getCol();
                    //     },
                    //     error: function() {
                    //         console.log('ajax error');
                    //     }
                    // });
                },
                
                updateDb(btnEl) {
                    // console.log('AAAA')
                    if (btnEl.innerText === '新增') {
                        this.displaynone = false;
                        this.detail = {}
                        // 選第二個選項時 第一個名稱會消失?
                    }else if (btnEl.innerText === '修改') {
                        

                    }else if (btnEl.innerText === '下架') {

                    }
                },
                // 新增按下去時出現燈箱 
             
                // 解構欄位
                deconstructRow(row, idx) {
                    let {prodName, cateType, cateName, price, prodIntro, status, ...detail} = row;
                    deconstructResult = {prodName, cateType, cateName, price, detail, prodIntro, status};
                    // 不解構
                    // deconstructResult = this.queryResult[idx];
                },

                // 取得詳細資訊
                getDetail(idx) {
                    this.displaynone = false;
                    this.detail = this.queryResult[idx];
                    // queryResult[idx] 收到點到整筆資料的索引值 
                    // console.log(detail);
                    let thisVue = this;
                    let xhr = new XMLHttpRequest();
                    xhr.onload = function(){
                        alert(xhr.responseText);
                    }
                    // insert
                    xhr.open("post","phps/back_products_modify_test.php",true);
                    let form = document.getElementById("good");
                    let formData = new FormData(form);
                    xhr.send(formData);
                }
            },
            computed: {
                popup() {
                    return {
                        popup: true,
                        display_none: this.displaynone
                    }
                }
            }
        });
    });
</script>