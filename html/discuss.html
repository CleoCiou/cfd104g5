<!DOCTYPE html>
<html lang="en">

    @@include('layout/head.html', {
        'title': '星座討論區'
    })
    
    <!-- <script src="js/lightbox.js"></script> -->

<body>    
    <!-- 網頁頭 by NJ -->
    @@include('layout/header.html')    
    <main>
        <div id="app">
            <!-- 星座頁籤 謝謝蘋姊拯救世界 by JC -->
            @@include('layout/con_page.html')
             <!-- 討論區 by JC -->
            <section class="discuss">
                <!-- 控制整個討論區padding的大大容器 -->
                <div class="container">
                    <!-- 最上面搜尋bar,撰寫,我的 -->
                    <div class="content_head">
                        <div class="content_header">
                            <div class="search_bar">
                                <input type="search" id="search">
                                <input type="submit" value="搜尋" class="third_btn">
                            </div>
                            <div class="icon_btn">
                                <a href="discuss_write.html"><img src="images/icon/icon_discuss_add.svg" alt="撰寫文章"></a>
                                <a href="discuss_mine.html"><img src="images/icon/icon_discuss_mine.svg" alt="我的文章"></a>
                            </div>
                        </div>
                    </div>
                    <!-- 貓頭鷹分類 -->
                    <div class="owl-carousel owl-theme display">
                        <div class="item" v-for="(name,index) in cates">
                            <label>{{name.topicName}}</label>
                        </div>
                    </div>
                    <!-- 文章 搜尋bar下排包住左邊和右邊的容器 -->
                    <div class="content">
                        
                        <!-- 左邊分類欄 -->
                        <div class="content_cate">
                            <ul>
                                <li v-for="(name,index) in cates"><label class="category">{{name.topicName}}</label></li>
                            </ul>
                        </div>

                        <!-- 右邊內容欄 -->
                        <div class="content_article">
                            <div class="content_wrap">

                                <!-- 熱門 & 最新的兩個標籤 -->
                                <div class="content_label">
                                    <label v-for="(label,index) in labels" :key="index" @click="getPost(index)" :class="{select_label: isChecked == index}">{{label}}</label>
                                </div>
                                <!-- 放文章的地方 -->
                                <div class="row" >
                                    <!-- 文章卡片 -->
                                    <div class="article_cards" v-for="(card,index) in article.slice(startPage, startPage + perPage)">
                                        <div class="line_top">
                                            <p>{{article[index].topicName}}</p>
                                            <p>|</p>
                                            <p>{{article[index].artTime}}</p>
                                        </div>
                                        <div class="line_middle" @click="getIndex(index);showBoard =! showBoard">
                                            <div class="line_middle_txt">
                                                <h3>{{article[index].title}}</h3>
                                                <p class="words_limit">{{article[index].content}}</p>
                                            </div>
                                            <div class="line_middle_pic">    
                                            </div>
                                        </div>
                                        <div class="line_bottom">
                                            <!-- 愛心 -->
                                            <button class="using_btn"  @click="article[index].activeIndex =! article[index].activeIndex; changeLike(index)" >
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false" role="img" aria-hidden="true" class="fav_animation" :class="{active: article[index].activeIndex == 1}">
                                                    <path d="M16.5 4A5.49 5.49 0 0012 6.344 5.49 5.49 0 007.5 4 5.5 5.5 0 002 9.5C2 16 12 22 12 22s10-6 10-12.5A5.5 5.5 0 0016.5 4z" fill-rule="evenodd">
                                                    </path>
                                                </svg>
                                                <p>{{article[index].likes}}讚</p>
                                            </button>
                                            
                                            <!-- 留言 -->
                                            <img :src="iconMessage">
                                            <p>{{article[index].msgs}}回應</p>
                                            <!-- 收藏 -->
                                            <button class="using_btn" @click="article[index].favIndex =! article[index].favIndex">
                                                <svg viewBox="0 0 24 24" focusable="false" role="img" aria-hidden="true" class="origin fav_animation" :class="{active: article[index].favIndex == 1}">
                                                    <path d="M17.65 21.39L12 17.5l-5.65 3.88A1.5 1.5 0 014 20.15V5a2.5 2.5 0 012.5-2.5h11A2.5 2.5 0 0120 5v15.15a1.5 1.5 0 01-2.35 1.24z"></path>
                                                </svg>
                                                <p>收藏</p>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- 頁籤按鈕 -->
                                    <div class="content_pages">
                                        <ul>
                                            <!-- <li :class="{disabled: currentPage === 1}" @click="setPage(currentPage-1)"><a href="#">Prev</a></li> -->
                                            <button class="other_btn" v-for="n in totalPage" @click="setPage(n)"><a href="#">{{n}}</a></button>
                                            <!-- <li :class="{disabled: currentPage === totalPage}" @click="setPage(currentPage+1)"><a href="#"><span>&#10230;</span></a></li> -->
                                        </ul>
                                    </div>
                                </div>     
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- 文章瀏覽燈箱 by JC -->
            <section id="articleView" v-if="showBoard == 1" :class="{articleShow: showBoard == 1 }">
                <div class="container">
                    <div class="article_icon_box" @click="showBoard =! showBoard">
                        <img :src="iconClose" id="close">
                    </div>
                    <div class="author img_box narrow">
                        <img :src="imgSrc(getTitle.memImage)" alt="會員頭像">
                        <span>{{getTitle.memName}}</span>
                    </div>
                    <div class="article_view_title narrow">
                        <h3>{{getTitle.title}}</h3>
                        <a href="discuss.html">{{getTitle.topicName}}</a>
                        <p>{{getTitle.artTime}}</p>
                    </div>
                    <div class="article_view_content narrow">
                            <p>{{getTitle.content}}</p>
                    </div>
                    <!-- 功能列-- 愛心回應數分享等等 -->
                    <div class="article_using narrow">
                        <!-- 左 -->
                        <img src="images/icon/icon_discuss_likes.svg" alt="按喜歡的數量">
                        <p>{{getTitle.likes}}</p>
                        <span>| {{getTitle.msgs}} 回應</span>
                        <!-- 右 -->
                        <img src="images/icon/icon_discuss_favorite.svg" alt="收藏">
                        <img src="images/icon/icon_discuss_share.svg" alt="分享">
                        <img src="images/icon/icon_discuss_notice.svg" alt="檢舉" @click="showNotice =! showNotice">
                    </div>

                    <!-- 留言回應區塊  -->
                    <div class="article_response narrow">
                        <div class="response_head">
                            <h4>文章回應</h4>
                        </div>

                        <!-- 留言卡片 -->
                        <div class="response" v-for="(msg,index) in message">
                            <hr class="style">
                            <div class="response_card">
                                <div class="card_author img_box">
                                    <img :src="'./images/teller_mem/'+ message[index].memImage" alt="會員頭像">
                                </div>
                                <div class="card_txt">
                                    <div class="response_author">
                                        <span>{{message[index].memId}}</span>
                                    </div>
                                    <div class="response_card_content">
                                        <p>{{message[index].msgContent}}</p>
                                    </div>
                                    <div class="response_card_time">
                                        <span>{{message[index].msgTime}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 使用者要留言的地方 -->
                <div class="response_box">
                    <div class="user_img_box">
                        <img :src="imgSrc(userData.sticker)" alt="會員頭像">
                    </div>
                    <div class="user_txt_box">
                        <textarea  cols="1" rows="1" v-model="msgContent"></textarea>
                    </div>
                    <div class="res_btn_box">
                        <button class="submit_btn" @click="insertData">送出</button>
                    </div>
                </div>
            </section>

            <!-- 檢舉燈箱 by JC -->
            <section class="article_notice" id="notice_board" v-if="showNotice == 1" :class="{noticeShow: showNotice == 1 }">
                <div class="container">
                    <h3>檢舉文章</h3>
                    <h4>檢舉這篇文章的原因?</h4>
                    <form action="" class="form_notice">
                        <label>
                            <input type="radio" name="notice">
                            中傷、歧視、挑釁或謾罵他人
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            惡意洗板、重複張貼
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            包含色情、露點、性騷擾或血
                            腥恐怖等讓人不舒服之內容
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            暴力、傷害他人或傷害動物的
                            內容
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            文章發表在不適當的看板
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            文章內容空泛或明顯無意義內容
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            文章意圖號召他人按愛心，且無實質社會價值
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            包含未成年裸露、色情內容
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            未經當事人同意散佈私密色情影音內容
                        </label>
                        <label>
                            <input type="radio" name="notice">
                            其他原因
                        </label>
                    </form>
                    <div class="notice_btn_box">
                        <button class="third_btn" id="close_notice" @click="showNotice =! showNotice">取消</button>
                        <a href="#"><button type="submit" class="secondary_btn">完成</button></a>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <!-- 網頁尾 By NJ -->
    @@include('layout/footer.html')
    <script>
    // 若尚未登入
    if (getSessionData() !== false || getSessionData() === false) {
        getData();
    }

    function getData(){
        new Vue({
            el: '#app',
            data: { //變數放這
                userData: getSessionData(),
                urls: {
                    '體驗占卜師': 'be_tellers.html',
                    '線上占卜': 'online_divination.html',
                    '預約占卜師': 'teller_mem.html',
                    '塔羅討論區': 'discuss.html',
                },
                navs: ['體驗占卜師','線上占卜','占卜師總覽','塔羅討論區'],
                cates: {},
                labels: {
                            0: '熱門',
                            1: '最新',
                        },
                iconMessage: 'images/icon/icon_discuss_message.svg',
                iconClose: 'images/icon/icon_discuss_close.svg',
                author_img: 'images/black_cat_wizard.svg',
                isChecked: 0,
                showBoard: 0,
                showNotice: 0,
                index: '',
                article: [],
                message: [],
                getTitle: {},
                msgIdx: {},
                plusMsgIdx: {},
                newPost:[],
                perPage: 5,
                currentPage: 1,
                msgContent: '',
            },
            created() {
                this.getCol(this.isChecked);
                this.getTopic();
            },
            mounted() {
                
            },
            methods: {
                changeLike(index){
                    if(this.$data.article[index].activeIndex == 0){
                        this.$data.article[index].likes -= 1;
                    }else if(this.$data.article[index].activeIndex == 1){
                        this.$data.article[index].likes += 1;
                    }
                },
                imgSrc(image){
                let path = `images/teller_mem`;
                return `${path}/${image}`;
                },
                getIndex(index){
                    // console.log(this.getMsg(index));
                    this.getTitle = this.article[index];
                    this.getMsg(index);
                },
                getPost(index){
                    this.isChecked = index;
                    this.getCol(this.isChecked);
                },

                // 取文章跟燈箱的資料
                getCol(v) {
                    let thisVue = this;

                    if(v == 0){
                        $.ajax({
                            type: 'POST',
                            url: 'phps/post.php',
                            data: {
                                case: 'hotPost',
                            },
                            success: function(data) {
                                thisVue.article = data;
                            },
                            error: function() {
                                console.log('ajax error');
                            }
                        });
                    }else{
                        $.ajax({
                            type: 'POST',
                            url: 'phps/post.php',
                            data: {
                                case: 'newPost',
                            },
                            success: function(data) {
                                thisVue.article = data;
                            },
                            error: function() {
                                console.log('ajax error');
                            }
                        });
                    }
                },
                //取文章類別
                getTopic() {
                    $.ajax({
                        type: 'POST',
                        url: 'phps/select.php',
                        
                        data: {
                            table: 'article_topic',
                            queryCol: 'topicName',

                        },
                        success:  data => {
                            // console.log(data.msg);
                            if (data.msg !== false){
                                this.cates = data.msg;
                                // console.log(this.cates);
                            }
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                },
                //取留言的資料
                getMsg(index) {
                    let artNo = this.getTitle.artNo;
                    $.ajax({
                        type: 'POST',
                        url: 'phps/select.php',
                        
                        data: {
                            table: 'article_message',
                            queryCol: 'msgNo, artNo, msgTime, msgContent, memId, memImage',
                            joinTable: 'members',
                            joinOn: 'memNo',
                            condition: `article_message.artNo =  ${artNo}`,
                            other: 'order by msgTime',
                        },
                        success: data => {
                            // console.log(data.msg);
                            // console.log(data.sql);
                            if (data.msg !== false){
                                this.message = data.msg;
                            }
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                },
                //更新留言數量
                countMsg(index) {
                    let artNo = this.getTitle.artNo;
                    console.log(artNo);
                    $.ajax({
                        type: 'POST',
                        url: 'phps/update.php',
                        data: {
                            table: 'article',
                            updateValue: 'msgs = msgs + 1',
                            where: `artNo = '${artNo}'`
                        },
                        success: data => {
                            console.log('plus ok');
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                },
                insertData() {
                    let msgContent = this.msgContent;
                    let memNo = this.userData.userNo;
                    let artNo = this.getTitle.artNo;

                    // 新增資料
                    $.ajax({
                        type: 'POST',
                        url: 'phps/insert.php',
                        data: {
                            table: 'article_message',
                            // col: 'msgNo, artNo, memNo, msgTime, MsgContent, statue',
                            insertValue: `default, '${artNo}', '${memNo}', CURRENT_TIMESTAMP, '${msgContent}', default`
                        },
                        success: data => {
                            alert('留言成功');
                            window.location.reload();
                            this.getCol();
                            this.countMsg();
                        },
                        error: err => {
                            console.log('ajax error');
                        }
                    });
                },
                setPage(thePage){
                    this.currentPage = thePage;
                },
            },
            computed: {
                totalPage(){
                    return Math.ceil(this.article.length / this.perPage);
                },
                startPage(){
                    return (this.currentPage - 1) * this.perPage;
                },
            },
        });
    }
        
        $(document).ready(function(){
            $('.owl-carousel').owlCarousel({
                stagePadding: 10,
                loop:true,
                margin:5,
                nav:false,
                responsive:{
                    0:{
                        items:3
                    },
                    767:{
                        items:3
                    },

                }
            });
        });
    </script>
    
</body>
</html>